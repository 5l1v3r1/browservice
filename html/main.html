<html>
<head>
<title>BaaS</title>
<style>
body {
    overflow: hidden;
}
img {
    position: absolute;
    top: 0px;
    left: 0px;

    image-rendering: optimizeSpeed;
    image-rendering: -moz-crisp-edges;
    image-rendering: -o-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: pixelated;
    image-rendering: optimize-contrast;
    -ms-interpolation-mode: nearest-neighbor;
}
</style>
<script type="text/javascript">
window.onload = function() {

var retryInterval = 3000;
var maxRetries = 10;

var useOnMouseWheel = false;
var fixMousePosition = false;
var leftMouseButtonIs1 = false;
var bodyOverflowHiddenNotSupported = false;
(function() {
    var ua = window.navigator.userAgent;
    var msie = ua.indexOf('MSIE ');
    if(msie > 0) {
        var ver = parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
        if(ver <= 8) {
            useOnMouseWheel = true;
            fixMousePosition = true;
            leftMouseButtonIs1 = true;
        }
        if(ver <= 5) {
            bodyOverflowHiddenNotSupported = true;
        }
    }
})();

var imgIdx = 0;

var eventQueue = [];
var eventQueueStartIdx = 0;

var mouseMoved = false;
var mouseX = 0;
var mouseY = 0;
function updateMousePos(event) {
    mouseX = event.clientX | 0;
    mouseY = event.clientY | 0;
    if(fixMousePosition) {
        mouseX -= 2;
        mouseY -= 2;
    }
}

var img1 = {};
var img2 = {};
function setupImg(img, nextImg, elem) {
    img.elem = elem;

    var imgLoaded;
    var attempts;
    var eventIdxIncrement;
    var mouseMoveEventAdded;
    var denyNewEventNotify = true;
    var active = false;

    var reloadIdx = 0;
    var reloadTimeout = null;
    function clearReloadTimeout() {
        ++reloadIdx;
        if(reloadTimeout) {
            clearTimeout(reloadTimeout);
        }
    };

    img.elem.onload = function() {
        if(!active) return;
        active = false;
        clearReloadTimeout();

        eventQueueStartIdx += eventIdxIncrement;
        var oldEventQueue = eventQueue;
        eventQueue = [];
        for(var i = eventIdxIncrement; i < oldEventQueue.length; ++i) {
            eventQueue[eventQueue.length] = oldEventQueue[i];
        }

        img.elem.style.zIndex = 3;
        nextImg.elem.style.zIndex = 2;

        nextImg.load();
    };

    function reload() {
        if(!active) return;

        if(attempts > maxRetries) {
            clearReloadTimeout();
            document.title = "BaaS: Connection lost";
            window.status = "BaaS: Connection lost";
            active = false;
            return;
        }
        ++attempts;

        if(mouseMoved && !mouseMoveEventAdded) {
            eventQueue[eventQueue.length] = 'MMO_' + mouseX + '_' + mouseY;
            mouseMoved = false;
            mouseMoveEventAdded = true;
        }

        var immediate = ((imgLoaded || imgIdx == 0) ? 1 : 0);
        imgLoaded = true;
        imgPath =
            "/%-sessionID-%/image/" +
            "%-mainIdx-%/" +
            (++imgIdx) + "/" +
            immediate + "/" +
            document.body.clientWidth + "/" +
            document.body.clientHeight + "/" +
            eventQueueStartIdx + "/";
        for(var i = 0; i < eventQueue.length; ++i) {
            imgPath += eventQueue[i] + "/";
        }
        img.elem.src = imgPath;

        var myReloadIdx = ++reloadIdx;
        reloadTimeout = setTimeout(function() {
            if(reloadIdx == myReloadIdx) {
                reload();
            }
        }, retryInterval);
    }

    img.newEventNotify = function() {
        if(!active) return;
        if(denyNewEventNotify) return;
        denyNewEventNotify = true;
        --attempts;
        clearReloadTimeout();
        reload();
    };

    img.load = function() {
        if(active) return;

        imgLoaded = false;
        attempts = 0;
        eventIdxIncrement = eventQueue.length;
        mouseMoveEventAdded = false;
        denyNewEventNotify = false;
        active = true;

        reload();
    };
}

setupImg(img1, img2, document.images[0]);
setupImg(img2, img1, document.images[1]);
img1.load();

function newEventNotify() {
    img1.newEventNotify();
    img2.newEventNotify();
}

function putEvent(event) {
    eventQueue[eventQueue.length] = event;
    newEventNotify();
}

function preventDefault(event) {
    if(event.preventDefault) {
        event.preventDefault();
    } else {
        event.returnValue = false;
    }
}

window.onresize = function() {
    newEventNotify();
};

document.onmousedown = function(event) {
    if(!event) event = window.event;
    updateMousePos(event);
    var button = event.button | 0;
    if(button >= 0 && button <= 2) {
        if(leftMouseButtonIs1 && button == 1) {
            button = 0;
        }
        putEvent('MDN_' + mouseX + '_' + mouseY + '_' + button);
    }
    preventDefault(event);
};

document.onmouseup = function(event) {
    if(!event) event = window.event;
    updateMousePos(event);
    var button = event.button | 0;
    if(button >= 0 && button <= 2) {
        if(leftMouseButtonIs1 && button == 1) {
            button = 0;
        }
        putEvent('MUP_' + mouseX + '_' + mouseY + '_' + button);
    }
    preventDefault(event);
};

document.ondblclick = function(event) {
    if(!event) event = window.event;
    updateMousePos(event);
    putEvent('MDBL_' + mouseX + '_' + mouseY);
    preventDefault(event);
};

document.onmousemove = function(event) {
    if(!event) event = window.event;
    updateMousePos(event);
    if(!mouseMoved) {
        mouseMoved = true;
        newEventNotify();
    }
};

if(useOnMouseWheel) {
    document.onmousewheel = function(event) {
        if(!event) event = window.event;
        putEvent('MWH_' + mouseX + '_' + mouseY + '_' + (event.wheelDelta | 0));
    };
} else {
    document.onwheel = function(event) {
        putEvent('MWH_' + mouseX + '_' + mouseY + '_' + ((-30 * event.deltaY) | 0));
    };
}

document.body.onmouseleave = function() {
    putEvent('MOUT_' + mouseX + '_' + mouseY);
};

window.onblur = function() {
    putEvent('FOUT');
};

document.ondragstart = function() {
    return false;
};

document.oncontextmenu = function(event) {
    if(!event) event = window.event;
    preventDefault(event);
};

var nonCharKeyList = [%-nonCharKeyList-%];
var nonCharKeys = {};
for(var i = 0; i < nonCharKeyList.length; ++i) {
    nonCharKeys[nonCharKeyList[i]] = true;
}

document.onkeypress = function(event) {
    if(!event) {
        event = window.event;
        var key = event.keyCode | 0;
    } else {
        var key = event.which |Â 0;
    }
    if(key <= 0) return;
    putEvent('KPR_' + key);
    preventDefault(event);
};

var nonCharKeyList = [%-nonCharKeyList-%];
var nonCharKeys = {};
for(var i = 0; i < nonCharKeyList.length; ++i) {
    nonCharKeys[nonCharKeyList[i]] = true;
}

var nonCharKeysDown = {};

document.onkeydown = function(event) {
    if(!event) {
        event = window.event;
        var key = event.keyCode | 0;
    } else {
        var key = event.which | 0;
    }
    if(!nonCharKeys[key]) return;
    putEvent('KDN_' + key);
    preventDefault(event);
};

document.onkeyup = function(event) {
    if(!event) {
        event = window.event;
        var key = event.keyCode | 0;
    } else {
        var key = event.which | 0;
    }
    if(!nonCharKeys[key]) return;
    putEvent('KUP_' + key);
    preventDefault(event);
};

};
</script>
</head>
<body>
<img>
<img>
</body>
</html>
